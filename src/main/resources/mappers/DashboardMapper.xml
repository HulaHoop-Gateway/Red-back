<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hulahoop.redback.dashboard.model.dao.DashboardMapper">

    <select id="countTotalMembers" resultType="long">
        SELECT COUNT(*) FROM T_Member
    </select>

    <select id="countTotalMerchants" resultType="long">
        SELECT COUNT(*) FROM T_Merchant
    </select>

    <select id="countTotalApiRequests" resultType="long">
        SELECT COALESCE(SUM(CAST(call_count AS UNSIGNED)), 0) FROM T_API
    </select>

    <select id="countTotalTransactions" resultType="long">
        SELECT COUNT(*) FROM T_TransactionHistory
    </select>

    <select id="selectDailyTransactions" resultType="map">
        SELECT
            DATE_FORMAT(payment_date, '%m/%d') as date,
            SUM(amount_used) as amount
        FROM T_TransactionHistory
        WHERE status = 'S'
          AND payment_date >= CURDATE() - INTERVAL 6 DAY
        GROUP BY DATE_FORMAT(payment_date, '%m/%d')
        ORDER BY date ASC
        LIMIT 7
    </select>

    <select id="selectMonthlyTransactions" resultType="map">
    <![CDATA[
        SELECT
            DATE_FORMAT(payment_date, '%m월') as month,
            SUM(amount_used) as amount
        FROM T_TransactionHistory
        WHERE status = 'S'
          AND payment_date >= '2025-06-01'
          AND payment_date <= CURDATE()
        GROUP BY DATE_FORMAT(payment_date, '%m월')
        ORDER BY month ASC
            LIMIT 12
        ]]>
</select>


    <select id="selectMerchantUsage" resultType="map">
        SELECT
            m.merchant_name as name,
            COUNT(*) as value
        FROM T_TransactionHistory th
        JOIN T_Merchant m ON th.merchant_code = m.merchant_code
        WHERE th.status = 'S'
        GROUP BY m.merchant_name
        ORDER BY value DESC
    </select>

</mapper>
